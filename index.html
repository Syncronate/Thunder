<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THUNDER - Sala Operativa Protezione Civile</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0e14;
            --bg-secondary: #13171d;
            --bg-tertiary: #1a1f29;
            --bg-elevated: #212730;
            --border-primary: #2d3541;
            --border-secondary: #3d4552;
            --text-primary: #e6e8eb;
            --text-secondary: #9ca3af;
            --text-tertiary: #6b7280;
            --status-critical: #dc2626;
            --status-high: #f59e0b;
            --status-medium: #3b82f6;
            --status-low: #10b981;
            --color-success: #10b981;
            --color-warning: #f59e0b;
            --color-error: #dc2626;
            --color-info: #3b82f6;
            --accent-primary: #2563eb;
            --accent-hover: #3b82f6;
            --squad-available: #10b981;
            --squad-busy: #f59e0b;
            --squad-offline: #6b7280;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
        }

        #app {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* HEADER */
        .app-header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-primary);
            padding: 0 20px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-icon {
            font-size: 28px;
        }

        .logo-text {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: 2px;
        }

        .logo-subtitle {
            font-size: 12px;
            color: var(--text-secondary);
            padding-left: 10px;
            border-left: 1px solid var(--border-primary);
        }

        .header-center {
            flex: 1;
            display: flex;
            justify-content: center;
        }

        .current-time {
            text-align: center;
        }

        .time-label {
            font-size: 10px;
            color: var(--text-tertiary);
            display: block;
        }

        .time-value {
            font-size: 20px;
            font-weight: 600;
            font-variant-numeric: tabular-nums;
        }

        .date-value {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .header-indicators {
            display: flex;
            gap: 15px;
        }

        .indicator {
            text-align: center;
        }

        .indicator-label {
            font-size: 10px;
            color: var(--text-tertiary);
            display: block;
        }

        .indicator-value {
            font-size: 18px;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
        }

        .indicator-value.critical { color: var(--status-critical); }
        .indicator-value.warning { color: var(--status-high); }
        .indicator-value.success { color: var(--status-low); }

        /* MAIN LAYOUT */
        .app-body {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* SIDEBAR */
        .app-sidebar {
            width: 260px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-primary);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .sidebar-nav {
            padding: 20px 10px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 15px;
            color: var(--text-secondary);
            text-decoration: none;
            border-radius: 6px;
            margin-bottom: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .nav-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: var(--accent-primary);
            color: white;
        }

        .nav-icon {
            font-size: 18px;
            width: 20px;
        }

        .nav-label {
            flex: 1;
            font-size: 14px;
        }

        .nav-badge {
            background: var(--status-critical);
            color: white;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 600;
        }

        .nav-divider {
            height: 1px;
            background: var(--border-primary);
            margin: 10px 0;
        }

        .sidebar-quick-actions {
            padding: 10px;
            border-top: 1px solid var(--border-primary);
        }

        /* MAIN CONTENT */
        .app-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .content-header {
            padding: 20px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .breadcrumb {
            font-size: 24px;
            font-weight: 600;
        }

        .content-actions {
            display: flex;
            gap: 10px;
        }

        .search-bar input {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            color: var(--text-primary);
            padding: 8px 15px;
            border-radius: 6px;
            width: 300px;
            font-size: 14px;
        }

        .search-bar input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .content-body {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        /* BUTTONS */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--accent-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
        }

        .btn-secondary {
            background: var(--bg-elevated);
            color: var(--text-primary);
            border: 1px solid var(--border-primary);
        }

        .btn-secondary:hover {
            background: var(--bg-tertiary);
        }

        .btn-success {
            background: var(--color-success);
            color: white;
        }

        .btn-danger {
            background: var(--color-error);
            color: white;
        }

        .btn-block {
            width: 100%;
            justify-content: center;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        /* CARDS */
        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .card-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
        }

        .card-body {
            padding: 20px;
        }

        .card-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--border-primary);
            background: var(--bg-tertiary);
        }

        /* BADGES */
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-critical {
            background: rgba(220, 38, 38, 0.2);
            color: var(--status-critical);
            border: 1px solid var(--status-critical);
        }

        .badge-high {
            background: rgba(245, 158, 11, 0.2);
            color: var(--status-high);
            border: 1px solid var(--status-high);
        }

        .badge-medium {
            background: rgba(59, 130, 246, 0.2);
            color: var(--status-medium);
            border: 1px solid var(--status-medium);
        }

        .badge-low {
            background: rgba(16, 185, 129, 0.2);
            color: var(--status-low);
            border: 1px solid var(--status-low);
        }

        .badge-aperta { background: rgba(59, 130, 246, 0.2); color: var(--status-medium); border: 1px solid var(--status-medium); }
        .badge-in_corso { background: rgba(245, 158, 11, 0.2); color: var(--status-high); border: 1px solid var(--status-high); }
        .badge-chiusa { background: rgba(107, 114, 128, 0.2); color: var(--text-tertiary); border: 1px solid var(--text-tertiary); }

        /* DASHBOARD GRID */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            padding: 20px;
        }

        .stat-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .stat-card-title {
            font-size: 13px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card-icon {
            font-size: 24px;
            opacity: 0.5;
        }

        .stat-card-value {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-card-label {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        /* TABLE */
        .table-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: var(--bg-tertiary);
        }

        th {
            padding: 12px 15px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border-primary);
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-primary);
            font-size: 14px;
        }

        tbody tr {
            transition: background 0.2s;
            cursor: pointer;
        }

        tbody tr:hover {
            background: var(--bg-tertiary);
        }

        /* FORM */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text-secondary);
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            color: var(--text-primary);
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        /* MODAL */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .modal-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--border-primary);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* MAP */
        .map-container {
            height: 500px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border-primary);
        }

        /* TIMELINE */
        .timeline {
            position: relative;
            padding-left: 30px;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--border-primary);
        }

        .timeline-item {
            position: relative;
            padding-bottom: 20px;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -26px;
            top: 5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--accent-primary);
            border: 2px solid var(--bg-primary);
        }

        .timeline-time {
            font-size: 12px;
            color: var(--text-tertiary);
            margin-bottom: 5px;
        }

        .timeline-content {
            background: var(--bg-tertiary);
            padding: 15px;
            border-radius: 6px;
            border: 1px solid var(--border-primary);
        }

        /* TOAST */
        .toast-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: var(--bg-elevated);
            border: 1px solid var(--border-primary);
            border-radius: 6px;
            padding: 15px 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            min-width: 300px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast-success { border-left: 4px solid var(--color-success); }
        .toast-error { border-left: 4px solid var(--color-error); }
        .toast-warning { border-left: 4px solid var(--color-warning); }
        .toast-info { border-left: 4px solid var(--color-info); }

        /* UTILITIES */
        .text-critical { color: var(--status-critical); }
        .text-high { color: var(--status-high); }
        .text-medium { color: var(--status-medium); }
        .text-low { color: var(--status-low); }
        .text-muted { color: var(--text-tertiary); }
        .mb-20 { margin-bottom: 20px; }
        .mt-20 { margin-top: 20px; }
        
        .actions-cell {
            display: flex;
            gap: 8px;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-secondary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-tertiary);
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- HEADER -->
        <header class="app-header">
            <div class="header-left">
                <div class="logo">
                    <span class="logo-icon">‚ö°</span>
                    <span class="logo-text">THUNDER</span>
                    <span class="logo-subtitle">Sala Operativa</span>
                </div>
            </div>
            
            <div class="header-center">
                <div class="current-time">
                    <span class="time-label">ORA SISTEMA</span>
                    <div class="time-value">{{ currentTime }}</div>
                    <div class="date-value">{{ currentDate }}</div>
                </div>
            </div>
            
            <div class="header-right">
                <div class="header-indicators">
                    <div class="indicator">
                        <span class="indicator-label">Segnalazioni</span>
                        <span class="indicator-value critical">{{ stats.segnalazioniAperte }}</span>
                    </div>
                    <div class="indicator">
                        <span class="indicator-label">Interventi</span>
                        <span class="indicator-value warning">{{ stats.interventiAttivi }}</span>
                    </div>
                    <div class="indicator">
                        <span class="indicator-label">Squadre</span>
                        <span class="indicator-value success">{{ stats.squadreDisponibili }}/{{ stats.squadreTotali }}</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- BODY -->
        <div class="app-body">
            <!-- SIDEBAR -->
            <aside class="app-sidebar">
                <nav class="sidebar-nav">
                    <a @click="currentView = 'dashboard'" :class="['nav-item', { active: currentView === 'dashboard' }]">
                        <span class="nav-icon">üìä</span>
                        <span class="nav-label">Dashboard</span>
                    </a>
                    
                    <a @click="currentView = 'segnalazioni'" :class="['nav-item', { active: currentView === 'segnalazioni' }]">
                        <span class="nav-icon">‚ö†Ô∏è</span>
                        <span class="nav-label">Segnalazioni</span>
                        <span v-if="stats.segnalazioniAperte > 0" class="nav-badge">{{ stats.segnalazioniAperte }}</span>
                    </a>
                    
                    <a @click="currentView = 'interventi'" :class="['nav-item', { active: currentView === 'interventi' }]">
                        <span class="nav-icon">üõ†Ô∏è</span>
                        <span class="nav-label">Interventi</span>
                        <span v-if="stats.interventiAttivi > 0" class="nav-badge">{{ stats.interventiAttivi }}</span>
                    </a>
                    
                    <a @click="currentView = 'comunicazioni'" :class="['nav-item', { active: currentView === 'comunicazioni' }]">
                        <span class="nav-icon">üìû</span>
                        <span class="nav-label">Comunicazioni</span>
                    </a>
                    
                    <a @click="currentView = 'squadre'" :class="['nav-item', { active: currentView === 'squadre' }]">
                        <span class="nav-icon">üë•</span>
                        <span class="nav-label">Squadre</span>
                    </a>
                    
                    <a @click="currentView = 'mappa'" :class="['nav-item', { active: currentView === 'mappa' }]">
                        <span class="nav-icon">üó∫Ô∏è</span>
                        <span class="nav-label">Mappa</span>
                    </a>
                    
                    <div class="nav-divider"></div>
                    
                    <a @click="currentView = 'rubrica'" :class="['nav-item', { active: currentView === 'rubrica' }]">
                        <span class="nav-icon">üìñ</span>
                        <span class="nav-label">Rubrica</span>
                    </a>
                    
                    <a @click="currentView = 'diario'" :class="['nav-item', { active: currentView === 'diario' }]">
                        <span class="nav-icon">üìù</span>
                        <span class="nav-label">Diario Sala</span>
                    </a>
                </nav>
                
                <div class="sidebar-quick-actions">
                    <button @click="showNewSegnalazione" class="btn btn-primary btn-block">
                        ‚ûï Nuova Segnalazione
                    </button>
                    <button @click="showNewComunicazione" class="btn btn-secondary btn-block" style="margin-top: 10px;">
                        ‚ûï Comunicazione
                    </button>
                </div>
            </aside>

            <!-- MAIN CONTENT -->
            <main class="app-main">
                <div class="content-header">
                    <div class="breadcrumb">{{ viewTitle }}</div>
                    <div class="content-actions">
                        <div class="search-bar">
                            <input type="search" v-model="searchQuery" placeholder="Cerca... (Ctrl+K)" />
                        </div>
                        <button @click="exportData" class="btn btn-secondary">üíæ Export</button>
                    </div>
                </div>
                
                <div class="content-body">
                    <!-- DASHBOARD VIEW -->
                    <div v-if="currentView === 'dashboard'">
                        <div class="dashboard-grid">
                            <div class="stat-card">
                                <div class="stat-card-header">
                                    <span class="stat-card-title">Segnalazioni Aperte</span>
                                    <span class="stat-card-icon">‚ö†Ô∏è</span>
                                </div>
                                <div class="stat-card-value text-critical">{{ stats.segnalazioniAperte }}</div>
                                <div class="stat-card-label">di cui {{ segnalazioniCritiche.length }} critiche</div>
                            </div>

                            <div class="stat-card">
                                <div class="stat-card-header">
                                    <span class="stat-card-title">Interventi Attivi</span>
                                    <span class="stat-card-icon">üõ†Ô∏è</span>
                                </div>
                                <div class="stat-card-value text-high">{{ stats.interventiAttivi }}</div>
                                <div class="stat-card-label">in corso</div>
                            </div>

                            <div class="stat-card">
                                <div class="stat-card-header">
                                    <span class="stat-card-title">Squadre Disponibili</span>
                                    <span class="stat-card-icon">üë•</span>
                                </div>
                                <div class="stat-card-value text-low">{{ stats.squadreDisponibili }}</div>
                                <div class="stat-card-label">su {{ stats.squadreTotali }} totali</div>
                            </div>

                            <div class="stat-card">
                                <div class="stat-card-header">
                                    <span class="stat-card-title">Comunicazioni Oggi</span>
                                    <span class="stat-card-icon">üìû</span>
                                </div>
                                <div class="stat-card-value text-medium">{{ comunicazioniOggi.length }}</div>
                                <div class="stat-card-label">ultime 24h</div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">‚ö° Attivit√† Recenti</h3>
                            </div>
                            <div class="card-body">
                                <div class="timeline">
                                    <div v-for="evento in eventiRecenti" :key="evento.id" class="timeline-item">
                                        <div class="timeline-time">{{ formatTime(evento.timestamp) }}</div>
                                        <div class="timeline-content">
                                            <strong>{{ evento.tipo }}</strong>: {{ evento.descrizione }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SEGNALAZIONI VIEW -->
                    <div v-if="currentView === 'segnalazioni'">
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Codice</th>
                                        <th>Tipologia</th>
                                        <th>Descrizione</th>
                                        <th>Localit√†</th>
                                        <th>Priorit√†</th>
                                        <th>Stato</th>
                                        <th>Data</th>
                                        <th>Azioni</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="seg in filteredSegnalazioni" :key="seg.id">
                                        <td><strong>{{ seg.codice }}</strong></td>
                                        <td>{{ seg.tipologia }}</td>
                                        <td>{{ seg.descrizione }}</td>
                                        <td>{{ seg.localita.comune }}</td>
                                        <td><span :class="'badge badge-' + seg.priorita.toLowerCase()">{{ seg.priorita }}</span></td>
                                        <td><span :class="'badge badge-' + seg.stato.toLowerCase()">{{ seg.stato }}</span></td>
                                        <td>{{ formatDate(seg.dataCreazione) }}</td>
                                        <td class="actions-cell">
                                            <button @click="viewSegnalazione(seg)" class="btn btn-sm btn-secondary">üëÅÔ∏è</button>
                                            <button @click="editSegnalazione(seg)" class="btn btn-sm btn-secondary">‚úèÔ∏è</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- INTERVENTI VIEW -->
                    <div v-if="currentView === 'interventi'">
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Codice</th>
                                        <th>Segnalazione</th>
                                        <th>Descrizione</th>
                                        <th>Squadre</th>
                                        <th>Stato</th>
                                        <th>Inizio</th>
                                        <th>Azioni</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="int in interventi" :key="int.id">
                                        <td><strong>{{ int.codice }}</strong></td>
                                        <td>{{ int.segnalazioneCodice }}</td>
                                        <td>{{ int.descrizione }}</td>
                                        <td>{{ int.squadreAssegnate.length }}</td>
                                        <td><span :class="'badge badge-' + int.stato.toLowerCase()">{{ int.stato }}</span></td>
                                        <td>{{ formatDate(int.dataInizio) }}</td>
                                        <td class="actions-cell">
                                            <button @click="viewIntervento(int)" class="btn btn-sm btn-secondary">üëÅÔ∏è</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- COMUNICAZIONI VIEW -->
                    <div v-if="currentView === 'comunicazioni'">
                        <div class="card">
                            <div class="card-body">
                                <div class="timeline">
                                    <div v-for="com in comunicazioni" :key="com.id" class="timeline-item">
                                        <div class="timeline-time">{{ formatDateTime(com.timestamp) }}</div>
                                        <div class="timeline-content">
                                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                                <div>
                                                    <span :class="'badge badge-' + (com.tipo === 'ENTRATA' ? 'medium' : 'low')">{{ com.tipo }}</span>
                                                    <span class="badge" style="margin-left: 5px;">{{ com.canale }}</span>
                                                </div>
                                                <span :class="'badge badge-' + com.priorita.toLowerCase()">{{ com.priorita }}</span>
                                            </div>
                                            <div><strong>Da:</strong> {{ com.mittente }} <strong>A:</strong> {{ com.destinatario }}</div>
                                            <div style="margin-top: 10px;">{{ com.contenuto }}</div>
                                            <div style="margin-top: 10px; font-size: 12px; color: var(--text-tertiary);">
                                                Operatore: {{ com.operatore }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SQUADRE VIEW -->
                    <div v-if="currentView === 'squadre'">
                        <div class="dashboard-grid">
                            <div v-for="squadra in squadre" :key="squadra.id" class="card">
                                <div class="card-header">
                                    <h3 class="card-title">{{ squadra.nome }}</h3>
                                    <span :class="'badge badge-' + squadra.stato.toLowerCase()">{{ squadra.stato }}</span>
                                </div>
                                <div class="card-body">
                                    <div style="margin-bottom: 10px;"><strong>Codice:</strong> {{ squadra.codice }}</div>
                                    <div style="margin-bottom: 10px;"><strong>Specializzazione:</strong> {{ squadra.specializzazione }}</div>
                                    <div style="margin-bottom: 10px;"><strong>Caposquadra:</strong> {{ squadra.caposquadra }}</div>
                                    <div style="margin-bottom: 10px;"><strong>Componenti:</strong> {{ squadra.componenti.length }}</div>
                                    <div style="margin-bottom: 10px;"><strong>Contatto:</strong> {{ squadra.contattoTelefonico }}</div>
                                    <div v-if="squadra.interventoCorrente" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-primary);">
                                        <strong>Intervento in corso:</strong> {{ squadra.interventoCorrente }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- MAPPA VIEW -->
                    <div v-if="currentView === 'mappa'">
                        <div id="map" class="map-container"></div>
                    </div>

                    <!-- RUBRICA VIEW -->
                    <div v-if="currentView === 'rubrica'">
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>Organizzazione</th>
                                        <th>Ruolo</th>
                                        <th>Telefono</th>
                                        <th>Email</th>
                                        <th>Categoria</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="contatto in contatti" :key="contatto.id">
                                        <td><strong>{{ contatto.nome }} {{ contatto.cognome }}</strong></td>
                                        <td>{{ contatto.organizzazione }}</td>
                                        <td>{{ contatto.ruolo }}</td>
                                        <td>{{ contatto.telefono }}</td>
                                        <td>{{ contatto.email }}</td>
                                        <td><span class="badge badge-medium">{{ contatto.categoria }}</span></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- DIARIO VIEW -->
                    <div v-if="currentView === 'diario'">
                        <div class="card mb-20">
                            <div class="card-header">
                                <h3 class="card-title">Nuovo Evento</h3>
                            </div>
                            <div class="card-body">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Tipologia</label>
                                        <select v-model="nuovoDiario.tipologia" class="form-select">
                                            <option>EVENTO</option>
                                            <option>COMUNICAZIONE</option>
                                            <option>DECISIONE</option>
                                            <option>NOTA</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Importanza</label>
                                        <select v-model="nuovoDiario.importanza" class="form-select">
                                            <option>NORMALE</option>
                                            <option>RILEVANTE</option>
                                            <option>CRITICA</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Contenuto</label>
                                    <textarea v-model="nuovoDiario.contenuto" class="form-textarea"></textarea>
                                </div>
                                <button @click="aggiungiDiario" class="btn btn-primary">‚úÖ Registra</button>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Registro Eventi</h3>
                            </div>
                            <div class="card-body">
                                <div class="timeline">
                                    <div v-for="voce in diarioSala" :key="voce.id" class="timeline-item">
                                        <div class="timeline-time">{{ formatDateTime(voce.timestamp) }}</div>
                                        <div class="timeline-content">
                                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                                <span class="badge badge-medium">{{ voce.tipologia }}</span>
                                                <span :class="'badge badge-' + (voce.importanza === 'CRITICA' ? 'critical' : voce.importanza === 'RILEVANTE' ? 'high' : 'low')">
                                                    {{ voce.importanza }}
                                                </span>
                                            </div>
                                            <div>{{ voce.contenuto }}</div>
                                            <div style="margin-top: 10px; font-size: 12px; color: var(--text-tertiary);">
                                                Operatore: {{ voce.operatore }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- MODAL NUOVA SEGNALAZIONE -->
        <div v-if="showModalSegnalazione" class="modal-overlay" @click="closeModal">
            <div class="modal-container" @click.stop>
                <div class="modal-header">
                    <h3 class="modal-title">Nuova Segnalazione</h3>
                    <button class="modal-close" @click="closeModal">√ó</button>
                </div>
                <div class="modal-body">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Tipologia *</label>
                            <select v-model="nuovaSegnalazione.tipologia" class="form-select">
                                <option>ALLAGAMENTO</option>
                                <option>FRANA</option>
                                <option>ALBERO_CADUTO</option>
                                <option>INCENDIO</option>
                                <option>BLACKOUT</option>
                                <option>ALTRO</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Priorit√† *</label>
                            <select v-model="nuovaSegnalazione.priorita" class="form-select">
                                <option>CRITICA</option>
                                <option>ALTA</option>
                                <option>MEDIA</option>
                                <option>BASSA</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Descrizione *</label>
                        <textarea v-model="nuovaSegnalazione.descrizione" class="form-textarea"></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Nome Richiedente</label>
                            <input v-model="nuovaSegnalazione.richiedente.nome" type="text" class="form-input" />
                        </div>
                        <div class="form-group">
                            <label class="form-label">Telefono Richiedente</label>
                            <input v-model="nuovaSegnalazione.richiedente.telefono" type="text" class="form-input" />
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Indirizzo *</label>
                        <input v-model="nuovaSegnalazione.localita.indirizzo" type="text" class="form-input" />
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Comune *</label>
                            <input v-model="nuovaSegnalazione.localita.comune" type="text" class="form-input" />
                        </div>
                        <div class="form-group">
                            <label class="form-label">Provincia</label>
                            <input v-model="nuovaSegnalazione.localita.provincia" type="text" class="form-input" />
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Note</label>
                        <textarea v-model="nuovaSegnalazione.note" class="form-textarea" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button @click="closeModal" class="btn btn-secondary">Annulla</button>
                    <button @click="salvaSegnalazione" class="btn btn-primary">üíæ Salva Segnalazione</button>
                </div>
            </div>
        </div>

        <!-- MODAL COMUNICAZIONE -->
        <div v-if="showModalComunicazione" class="modal-overlay" @click="closeModalComunicazione">
            <div class="modal-container" @click.stop>
                <div class="modal-header">
                    <h3 class="modal-title">Nuova Comunicazione</h3>
                    <button class="modal-close" @click="closeModalComunicazione">√ó</button>
                </div>
                <div class="modal-body">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Tipo *</label>
                            <select v-model="nuovaComunicazione.tipo" class="form-select">
                                <option>ENTRATA</option>
                                <option>USCITA</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Canale *</label>
                            <select v-model="nuovaComunicazione.canale" class="form-select">
                                <option>TELEFONO</option>
                                <option>RADIO</option>
                                <option>EMAIL</option>
                                <option>PERSONA</option>
                                <option>APP</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Mittente *</label>
                            <input v-model="nuovaComunicazione.mittente" type="text" class="form-input" />
                        </div>
                        <div class="form-group">
                            <label class="form-label">Destinatario *</label>
                            <input v-model="nuovaComunicazione.destinatario" type="text" class="form-input" />
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Priorit√†</label>
                        <select v-model="nuovaComunicazione.priorita" class="form-select">
                            <option>ALTA</option>
                            <option>MEDIA</option>
                            <option>BASSA</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Contenuto *</label>
                        <textarea v-model="nuovaComunicazione.contenuto" class="form-textarea"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button @click="closeModalComunicazione" class="btn btn-secondary">Annulla</button>
                    <button @click="salvaComunicazione" class="btn btn-primary">üíæ Registra</button>
                </div>
            </div>
        </div>

        <!-- TOAST NOTIFICATIONS -->
        <div class="toast-container">
            <div v-for="toast in toasts" :key="toast.id" :class="['toast', 'toast-' + toast.type]">
                {{ toast.message }}
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Dexie.js for IndexedDB -->
    <script src="https://unpkg.com/dexie@3.2.4/dist/dexie.min.js"></script>
    
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3.3.4/dist/vue.global.js"></script>

    <script>
        const { createApp } = Vue;

        // Database Setup
        const db = new Dexie('ThunderDB');
        db.version(1).stores({
            segnalazioni: '++id, codice, stato, priorita, tipologia, dataCreazione',
            interventi: '++id, codice, stato, segnalazioneId, dataInizio',
            comunicazioni: '++id, tipo, timestamp',
            squadre: '++id, codice, stato',
            contatti: '++id, categoria, cognome',
            diarioSala: '++id, timestamp, tipologia'
        });

        createApp({
            data() {
                return {
                    currentView: 'dashboard',
                    currentTime: '',
                    currentDate: '',
                    searchQuery: '',
                    
                    // Data
                    segnalazioni: [],
                    interventi: [],
                    comunicazioni: [],
                    squadre: [],
                    contatti: [],
                    diarioSala: [],
                    
                    // Modals
                    showModalSegnalazione: false,
                    showModalComunicazione: false,
                    
                    // Forms
                    nuovaSegnalazione: this.getEmptySegnalazione(),
                    nuovaComunicazione: this.getEmptyComunicazione(),
                    nuovoDiario: this.getEmptyDiario(),
                    
                    // Toasts
                    toasts: [],
                    toastId: 0,
                    
                    // Map
                    map: null
                }
            },
            
            computed: {
                viewTitle() {
                    const titles = {
                        dashboard: 'Dashboard',
                        segnalazioni: 'Segnalazioni',
                        interventi: 'Interventi',
                        comunicazioni: 'Comunicazioni',
                        squadre: 'Squadre',
                        mappa: 'Mappa Operativa',
                        rubrica: 'Rubrica Contatti',
                        diario: 'Diario di Sala'
                    };
                    return titles[this.currentView] || 'Thunder';
                },
                
                stats() {
                    return {
                        segnalazioniAperte: this.segnalazioni.filter(s => s.stato === 'APERTA' || s.stato === 'IN_CORSO').length,
                        interventiAttivi: this.interventi.filter(i => i.stato === 'IN_CORSO').length,
                        squadreDisponibili: this.squadre.filter(s => s.stato === 'DISPONIBILE').length,
                        squadreTotali: this.squadre.length
                    };
                },
                
                segnalazioniCritiche() {
                    return this.segnalazioni.filter(s => s.priorita === 'CRITICA' && s.stato !== 'CHIUSA');
                },
                
                comunicazioniOggi() {
                    const oggi = new Date().setHours(0,0,0,0);
                    return this.comunicazioni.filter(c => new Date(c.timestamp).setHours(0,0,0,0) === oggi);
                },
                
                eventiRecenti() {
                    const eventi = [];
                    
                    this.segnalazioni.slice(-5).forEach(s => {
                        eventi.push({
                            id: 'seg-' + s.id,
                            timestamp: s.dataCreazione,
                            tipo: 'SEGNALAZIONE',
                            descrizione: `Nuova segnalazione ${s.codice}: ${s.descrizione}`
                        });
                    });
                    
                    this.comunicazioni.slice(-5).forEach(c => {
                        eventi.push({
                            id: 'com-' + c.id,
                            timestamp: c.timestamp,
                            tipo: 'COMUNICAZIONE',
                            descrizione: `${c.tipo} da ${c.mittente}: ${c.contenuto.substring(0, 50)}...`
                        });
                    });
                    
                    return eventi.sort((a, b) => b.timestamp - a.timestamp).slice(0, 10);
                },
                
                filteredSegnalazioni() {
                    let result = this.segnalazioni;
                    if (this.searchQuery) {
                        const q = this.searchQuery.toLowerCase();
                        result = result.filter(s => 
                            s.codice.toLowerCase().includes(q) ||
                            s.descrizione.toLowerCase().includes(q) ||
                            s.localita.comune.toLowerCase().includes(q)
                        );
                    }
                    return result.sort((a, b) => b.dataCreazione - a.dataCreazione);
                }
            },
            
            methods: {
                // Init
                async loadData() {
                    this.segnalazioni = await db.segnalazioni.toArray();
                    this.interventi = await db.interventi.toArray();
                    this.comunicazioni = await db.comunicazioni.toArray();
                    this.squadre = await db.squadre.toArray();
                    this.contatti = await db.contatti.toArray();
                    this.diarioSala = await db.diarioSala.reverse().toArray();
                    
                    // Se non ci sono dati, inizializza con esempi
                    if (this.segnalazioni.length === 0) {
                        await this.initSampleData();
                    }
                },
                
                async initSampleData() {
                    // Segnalazioni
                    await db.segnalazioni.bulkAdd([
                        {
                            codice: 'SEG-2024-0001',
                            tipologia: 'ALLAGAMENTO',
                            priorita: 'ALTA',
                            stato: 'APERTA',
                            richiedente: { nome: 'Mario Rossi', telefono: '333-1234567' },
                            descrizione: 'Allagamento strada principale centro citt√†',
                            localita: { indirizzo: 'Via Roma 15', comune: 'Milano', provincia: 'MI', coordinate: { lat: 45.4642, lng: 9.1900 } },
                            dataCreazione: Date.now() - 3600000,
                            dataAggiornamento: Date.now() - 3600000,
                            operatoreCreazione: 'M. Bianchi',
                            note: '',
                            tags: ['viabilit√†', 'meteo']
                        },
                        {
                            codice: 'SEG-2024-0002',
                            tipologia: 'ALBERO_CADUTO',
                            priorita: 'CRITICA',
                            stato: 'IN_CORSO',
                            richiedente: { nome: 'Comune', telefono: '112' },
                            descrizione: 'Albero caduto su strada provinciale blocca traffico',
                            localita: { indirizzo: 'SP45 km 12', comune: 'Bergamo', provincia: 'BG', coordinate: { lat: 45.6983, lng: 9.6773 } },
                            dataCreazione: Date.now() - 1800000,
                            dataAggiornamento: Date.now() - 900000,
                            operatoreCreazione: 'G. Verdi',
                            note: 'Intervento squadra SAF in corso',
                            tags: ['viabilit√†', 'urgente']
                        }
                    ]);
                    
                    // Interventi
                    await db.interventi.bulkAdd([
                        {
                            codice: 'INT-2024-0001',
                            segnalazioneId: 2,
                            segnalazioneCodice: 'SEG-2024-0002',
                            tipologia: 'RIMOZIONE_OSTACOLO',
                            stato: 'IN_CORSO',
                            priorita: 'CRITICA',
                            descrizione: 'Rimozione albero caduto SP45',
                            dataInizio: Date.now() - 900000,
                            squadreAssegnate: [1, 2],
                            noteOperative: 'Utilizzare motosega e mezzo sollevamento'
                        }
                    ]);
                    
                    // Comunicazioni
                    await db.comunicazioni.bulkAdd([
                        {
                            tipo: 'ENTRATA',
                            canale: 'TELEFONO',
                            timestamp: Date.now() - 7200000,
                            mittente: 'Cittadino M. Rossi',
                            destinatario: 'Sala Operativa',
                            contenuto: 'Segnalazione allagamento Via Roma',
                            priorita: 'ALTA',
                            operatore: 'M. Bianchi'
                        },
                        {
                            tipo: 'USCITA',
                            canale: 'RADIO',
                            timestamp: Date.now() - 3600000,
                            mittente: 'Sala Operativa',
                            destinatario: 'Squadra SAF-1',
                            contenuto: 'Intervento richiesto SP45 km12 per albero caduto',
                            priorita: 'CRITICA',
                            operatore: 'G. Verdi'
                        }
                    ]);
                    
                    // Squadre
                    await db.squadre.bulkAdd([
                        {
                            codice: 'SAF-1',
                            nome: 'Squadra SAF Alpha',
                            specializzazione: 'SAF',
                            stato: 'IMPEGNATA',
                            componenti: [
                                { nome: 'Giuseppe Verdi', ruolo: 'Caposquadra' },
                                { nome: 'Andrea Neri', ruolo: 'Operatore' },
                                { nome: 'Luca Gialli', ruolo: 'Operatore' }
                            ],
                            caposquadra: 'Giuseppe Verdi',
                            mezzi: ['Pickup 4x4', 'Rimorchio attrezzature'],
                            interventoCorrente: 'INT-2024-0001',
                            contattoTelefonico: '335-9876543',
                            contattoRadio: 'Ch. 3 - SAF1'
                        },
                        {
                            codice: 'LOG-1',
                            nome: 'Squadra Logistica 1',
                            specializzazione: 'LOGISTICA',
                            stato: 'DISPONIBILE',
                            componenti: [
                                { nome: 'Marco Blu', ruolo: 'Caposquadra' },
                                { nome: 'Sara Rossi', ruolo: 'Operatore' }
                            ],
                            caposquadra: 'Marco Blu',
                            mezzi: ['Furgone'],
                            interventoCorrente: null,
                            contattoTelefonico: '335-1112222',
                            contattoRadio: 'Ch. 2 - LOG1'
                        }
                    ]);
                    
                    // Contatti
                    await db.contatti.bulkAdd([
                        {
                            tipologia: 'ENTE',
                            categoria: 'VVF',
                            nome: 'Comando',
                            cognome: 'VVF Milano',
                            organizzazione: 'Vigili del Fuoco',
                            ruolo: 'Comando Provinciale',
                            telefono: '02-115',
                            cellulare: '',
                            email: 'comando.milano@vigilfuoco.it',
                            radio: '',
                            indirizzo: { via: 'Via Messina 40', comune: 'Milano', provincia: 'MI' }
                        },
                        {
                            tipologia: 'PERSONA',
                            categoria: 'SANITARIO',
                            nome: 'Dott. Giovanni',
                            cognome: 'Bianchi',
                            organizzazione: 'AREU 118',
                            ruolo: 'Medico Coordinatore',
                            telefono: '02-118-9999',
                            cellulare: '335-9998887',
                            email: 'g.bianchi@areu.lombardia.it',
                            radio: 'Ch. 5',
                            indirizzo: { via: '', comune: 'Milano', provincia: 'MI' }
                        }
                    ]);
                    
                    // Diario Sala
                    await db.diarioSala.bulkAdd([
                        {
                            timestamp: Date.now() - 7200000,
                            operatore: 'M. Bianchi',
                            turno: '08:00-16:00',
                            tipologia: 'EVENTO',
                            contenuto: 'Apertura sala operativa - turno mattina',
                            importanza: 'NORMALE'
                        },
                        {
                            timestamp: Date.now() - 3600000,
                            operatore: 'G. Verdi',
                            turno: '08:00-16:00',
                            tipologia: 'DECISIONE',
                            contenuto: 'Attivata squadra SAF-1 per emergenza SP45',
                            importanza: 'RILEVANTE'
                        }
                    ]);
                    
                    await this.loadData();
                },
                
                updateTime() {
                    const now = new Date();
                    this.currentTime = now.toLocaleTimeString('it-IT');
                    this.currentDate = now.toLocaleDateString('it-IT', { 
                        weekday: 'long', 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    });
                },
                
                // Modals
                showNewSegnalazione() {
                    this.nuovaSegnalazione = this.getEmptySegnalazione();
                    this.showModalSegnalazione = true;
                },
                
                closeModal() {
                    this.showModalSegnalazione = false;
                },
                
                showNewComunicazione() {
                    this.nuovaComunicazione = this.getEmptyComunicazione();
                    this.showModalComunicazione = true;
                },
                
                closeModalComunicazione() {
                    this.showModalComunicazione = false;
                },
                
                // CRUD Segnalazioni
                async salvaSegnalazione() {
                    const anno = new Date().getFullYear();
                    const count = await db.segnalazioni.count();
                    const codice = `SEG-${anno}-${String(count + 1).padStart(4, '0')}`;
                    
                    const segnalazione = {
                        ...this.nuovaSegnalazione,
                        codice,
                        stato: 'APERTA',
                        dataCreazione: Date.now(),
                        dataAggiornamento: Date.now(),
                        operatoreCreazione: 'Operatore Sistema'
                    };
                    
                    await db.segnalazioni.add(segnalazione);
                    await this.loadData();
                    this.closeModal();
                    this.showToast('success', 'Segnalazione creata con successo');
                    
                    // Aggiungi a diario
                    await db.diarioSala.add({
                        timestamp: Date.now(),
                        operatore: 'Sistema',
                        turno: 'Corrente',
                        tipologia: 'EVENTO',
                        contenuto: `Creata nuova segnalazione ${codice}: ${segnalazione.descrizione}`,
                        importanza: segnalazione.priorita === 'CRITICA' ? 'CRITICA' : 'NORMALE'
                    });
                },
                
                viewSegnalazione(seg) {
                    this.showToast('info', `Visualizzazione dettagli ${seg.codice}`);
                },
                
                editSegnalazione(seg) {
                    this.showToast('info', `Modifica ${seg.codice}`);
                },
                
                // CRUD Comunicazioni
                async salvaComunicazione() {
                    const comunicazione = {
                        ...this.nuovaComunicazione,
                        timestamp: Date.now(),
                        operatore: 'Operatore Sistema'
                    };
                    
                    await db.comunicazioni.add(comunicazione);
                    await this.loadData();
                    this.closeModalComunicazione();
                    this.showToast('success', 'Comunicazione registrata');
                },
                
                // Diario
                async aggiungiDiario() {
                    if (!this.nuovoDiario.contenuto) {
                        this.showToast('error', 'Inserire un contenuto');
                        return;
                    }
                    
                    const voce = {
                        ...this.nuovoDiario,
                        timestamp: Date.now(),
                        operatore: 'Operatore Sistema',
                        turno: 'Corrente'
                    };
                    
                    await db.diarioSala.add(voce);
                    await this.loadData();
                    this.nuovoDiario = this.getEmptyDiario();
                    this.showToast('success', 'Evento registrato nel diario');
                },
                
                // Export
                async exportData() {
                    const data = {
                        version: '1.0',
                        exportDate: new Date().toISOString(),
                        segnalazioni: this.segnalazioni,
                        interventi: this.interventi,
                        comunicazioni: this.comunicazioni,
                        squadre: this.squadre,
                        contatti: this.contatti,
                        diarioSala: this.diarioSala
                    };
                    
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `thunder-backup-${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                    
                    this.showToast('success', 'Dati esportati con successo');
                },
                
                // Helpers
                getEmptySegnalazione() {
                    return {
                        tipologia: 'ALTRO',
                        priorita: 'MEDIA',
                        descrizione: '',
                        richiedente: { nome: '', telefono: '' },
                        localita: { indirizzo: '', comune: '', provincia: '' },
                        note: ''
                    };
                },
                
                getEmptyComunicazione() {
                    return {
                        tipo: 'ENTRATA',
                        canale: 'TELEFONO',
                        mittente: '',
                        destinatario: '',
                        contenuto: '',
                        priorita: 'MEDIA'
                    };
                },
                
                getEmptyDiario() {
                    return {
                        tipologia: 'EVENTO',
                        contenuto: '',
                        importanza: 'NORMALE'
                    };
                },
                
                formatDate(timestamp) {
                    return new Date(timestamp).toLocaleDateString('it-IT');
                },
                
                formatTime(timestamp) {
                    return new Date(timestamp).toLocaleTimeString('it-IT');
                },
                
                formatDateTime(timestamp) {
                    return new Date(timestamp).toLocaleString('it-IT');
                },
                
                // Toast
                showToast(type, message) {
                    const id = ++this.toastId;
                    this.toasts.push({ id, type, message });
                    setTimeout(() => {
                        this.toasts = this.toasts.filter(t => t.id !== id);
                    }, 5000);
                },
                
                // Map
                initMap() {
                    if (this.map) return;
                    
                    this.$nextTick(() => {
                        const mapEl = document.getElementById('map');
                        if (!mapEl) return;
                        
                        this.map = L.map('map').setView([45.4642, 9.1900], 9);
                        
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '¬© OpenStreetMap contributors'
                        }).addTo(this.map);
                        
                        // Aggiungi markers segnalazioni
                        this.segnalazioni.forEach(seg => {
                            if (seg.localita.coordinate) {
                                const color = seg.priorita === 'CRITICA' ? 'red' : 
                                            seg.priorita === 'ALTA' ? 'orange' : 
                                            seg.priorita === 'MEDIA' ? 'blue' : 'green';
                                
                                const icon = L.divIcon({
                                    html: `<div style="background: ${color}; width: 24px; height: 24px; border-radius: 50%; border: 2px solid white;"></div>`,
                                    className: '',
                                    iconSize: [24, 24]
                                });
                                
                                L.marker([seg.localita.coordinate.lat, seg.localita.coordinate.lng], { icon })
                                    .addTo(this.map)
                                    .bindPopup(`
                                        <strong>${seg.codice}</strong><br>
                                        ${seg.descrizione}<br>
                                        <em>${seg.localita.indirizzo}</em>
                                    `);
                            }
                        });
                    });
                }
            },
            
            watch: {
                currentView(newView) {
                    if (newView === 'mappa') {
                        this.$nextTick(() => this.initMap());
                    }
                }
            },
            
            async mounted() {
                await this.loadData();
                this.updateTime();
                setInterval(() => this.updateTime(), 1000);
            }
        }).mount('#app');
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="it" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thunder - Sala Operativa Protezione Civile</title>
    
    <!-- Caricamento delle librerie da CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/dexie@3/dist/dexie.min.js"></script>
    <script src="https://unpkg.com/dayjs@1/dayjs.min.js"></script>
    <script src="https://unpkg.com/dayjs@1/locale/it.js"></script>
    <script src="https://unpkg.com/heroicons@2/24/outline/index.js"></script>

    <!-- Configurazione di Tailwind CSS con i colori e i font del progetto -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        'bg-primary': '#0a0e14',
                        'bg-secondary': '#13171d',
                        'bg-tertiary': '#1a1f29',
                        'bg-elevated': '#212730',
                        'border-primary': '#2d3541',
                        'border-secondary': '#3d4552',
                        'text-primary': '#e6e8eb',
                        'text-secondary': '#9ca3af',
                        'text-tertiary': '#6b7280',
                        'status-critical': '#dc2626',
                        'status-high': '#f59e0b',
                        'status-medium': '#3b82f6',
                        'status-low': '#10b981',
                        'accent-primary': '#2563eb',
                        'accent-hover': '#3b82f6',
                    }
                }
            }
        }
        dayjs.locale('it');
    </script>
    
    <style type="text/tailwindcss">
        /* Stili custom per l'applicazione */
        body { @apply bg-bg-primary text-text-primary font-sans antialiased; }
        .btn { @apply inline-block px-4 py-2 rounded-md font-semibold text-sm transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-bg-primary; }
        .btn-primary { @apply bg-accent-primary text-white hover:bg-accent-hover focus:ring-accent-primary; }
        .btn-secondary { @apply bg-bg-elevated text-text-primary border border-border-secondary hover:bg-bg-tertiary focus:ring-accent-hover; }
        .btn-danger { @apply bg-status-critical text-white hover:bg-red-500 focus:ring-status-critical; }
        .badge { @apply inline-block px-2.5 py-0.5 rounded-full text-xs font-semibold leading-tight; }
        .form-input { @apply w-full bg-bg-secondary border border-border-primary rounded-md px-3 py-2 text-text-primary placeholder-text-tertiary focus:outline-none focus:ring-2 focus:ring-accent-primary focus:border-transparent; }
        .form-label { @apply block text-sm font-medium text-text-secondary mb-1; }
        
        /* Stili per le icone di Heroicons */
        .icon { @apply w-5 h-5; }
        .nav-icon { @apply w-6 h-6; }
    </style>
</head>
<body class="overflow-hidden">

    <div id="app" class="h-screen w-screen">
        <!-- L'applicazione Vue verrà montata qui -->
        <div class="flex items-center justify-center h-full bg-bg-primary">
            <div class="text-center">
                <p class="text-2xl text-text-primary mb-2">⚡ Caricamento Thunder...</p>
                <p class="text-text-secondary">Inizializzazione sala operativa in corso.</p>
            </div>
        </div>
    </div>
    
    <!-- ====================================================================== -->
    <!-- TEMPLATES DEI COMPONENTI VUE -->
    <!-- ====================================================================== -->

    <!-- Template Principale (App.vue) -->
    <script type="text/x-template" id="app-template">
        <div class="h-screen w-screen grid grid-rows-[60px_1fr_40px] grid-cols-[240px_1fr] bg-bg-primary text-text-primary text-sm">
            
            <!-- HEADER -->
            <header class="col-span-2 bg-bg-secondary border-b border-border-primary flex items-center justify-between px-4">
                <div class="flex items-center gap-4">
                    <div class="text-xl font-bold flex items-center gap-2">
                        <span class="text-2xl">⚡</span>
                        <span>THUNDER</span>
                    </div>
                    <span class="text-xs text-text-tertiary mt-1">Sala Operativa</span>
                </div>
                <div class="font-mono text-center">
                    <div class="text-lg">{{ currentTime }}</div>
                    <div class="text-xs text-text-secondary">{{ currentDate }}</div>
                </div>
                <div class="flex items-center gap-6">
                    <div class="flex items-center gap-4 text-xs">
                        <div class="text-center">
                            <span class="text-text-tertiary">Segnalazioni</span>
                            <span class="block font-bold text-lg text-status-critical">{{ stats.aperte }}</span>
                        </div>
                        <div class="text-center">
                            <span class="text-text-tertiary">Interventi</span>
                            <span class="block font-bold text-lg text-status-high">0</span>
                        </div>
                        <div class="text-center">
                            <span class="text-text-tertiary">Squadre</span>
                            <span class="block font-bold text-lg text-status-low">0/0</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-right">M. Rossi<br><span class="text-xs text-text-tertiary">Operatore</span></span>
                        <div class="w-10 h-10 bg-bg-tertiary rounded-full"></div>
                    </div>
                </div>
            </header>

            <!-- SIDEBAR -->
            <aside class="bg-bg-secondary border-r border-border-primary flex flex-col justify-between p-4">
                <nav>
                    <ul>
                        <li v-for="item in navItems" :key="item.path">
                            <a :href="item.path" @click.prevent="navigateTo(item.path)" class="flex items-center gap-3 px-3 py-2.5 my-1 rounded-md transition-colors" :class="{'bg-accent-primary/20 text-accent-hover': currentPath === item.path, 'hover:bg-bg-tertiary text-text-secondary hover:text-text-primary': currentPath !== item.path}">
                                <component :is="item.icon" class="nav-icon"></component>
                                <span class="font-semibold">{{ item.name }}</span>
                                <span v-if="item.badge" class="ml-auto badge" :class="item.badge.class">{{ item.badge.value }}</span>
                            </a>
                        </li>
                    </ul>
                </nav>
                <div class="space-y-2">
                    <button @click="openNewSegnalazioneModal" class="btn btn-primary w-full">Nuova Segnalazione</button>
                    <button class="btn btn-secondary w-full">Registra Comunicazione</button>
                </div>
            </aside>

            <!-- MAIN CONTENT -->
            <main class="overflow-y-auto p-6">
                <component :is="currentView"></component>
            </main>

            <!-- FOOTER -->
            <footer class="col-span-2 bg-bg-secondary border-t border-border-primary flex items-center justify-between px-4 text-xs text-text-tertiary">
                <div>Thunder v1.0.0 (MVP)</div>
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-status-low animate-pulse"></span>
                        <span>Sistema Operativo</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-status-low"></span>
                        <span>Database Locale OK</span>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button class="btn btn-secondary !p-1.5 !text-xs">Export Dati</button>
                    <button class="btn btn-secondary !p-1.5 !text-xs">Backup</button>
                </div>
            </footer>

            <!-- MODAL NUOVA SEGNALAZIONE -->
            <segnalazione-form-modal v-if="isNewSegnalazioneModalOpen" @close="closeNewSegnalazioneModal"></segnalazione-form-modal>
        </div>
    </script>
    
    <!-- Template Dashboard (DashboardView.vue) -->
    <script type="text/x-template" id="dashboard-view-template">
        <div>
            <h1 class="text-2xl font-bold mb-6">Dashboard Sala Operativa</h1>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Colonna Sinistra -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- Pannello Situazione Generale -->
                    <div class="bg-bg-secondary p-6 rounded-lg border border-border-primary">
                        <h2 class="text-lg font-semibold mb-4">Pannello Situazione Generale</h2>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                            <div>
                                <p class="text-text-tertiary text-sm">Segnalazioni Aperte</p>
                                <p class="text-4xl font-bold text-status-critical">{{ stats.aperte }}</p>
                            </div>
                             <div>
                                <p class="text-text-tertiary text-sm">Interventi Attivi</p>
                                <p class="text-4xl font-bold text-status-high">0</p>
                            </div>
                             <div>
                                <p class="text-text-tertiary text-sm">Squadre Impegnate</p>
                                <p class="text-4xl font-bold text-status-medium">0</p>
                            </div>
                             <div>
                                <p class="text-text-tertiary text-sm">Totale Segnalazioni</p>
                                <p class="text-4xl font-bold text-text-secondary">{{ stats.totali }}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Segnalazioni Critiche -->
                    <div class="bg-bg-secondary p-6 rounded-lg border border-border-primary">
                        <h2 class="text-lg font-semibold mb-4">Allerte e Priorità Critiche</h2>
                        <div v-if="critiche.length > 0" class="space-y-3">
                            <div v-for="s in critiche" :key="s.id" class="flex items-center justify-between bg-bg-tertiary p-3 rounded-md">
                                <div class="flex items-center gap-3">
                                    <span class="badge bg-status-critical text-white">CRITICA</span>
                                    <div>
                                        <p class="font-semibold">{{ s.descrizione }}</p>
                                        <p class="text-xs text-text-secondary">{{ s.localita.indirizzo }}, {{ s.localita.comune }}</p>
                                    </div>
                                </div>
                                <span class="text-xs text-text-tertiary">{{ formatRelativeTime(s.dataCreazione) }}</span>
                            </div>
                        </div>
                        <p v-else class="text-text-secondary text-center py-4">Nessuna segnalazione critica non gestita.</p>
                    </div>
                </div>

                <!-- Colonna Destra -->
                <div class="space-y-6">
                    <!-- Timeline Tempo Reale -->
                    <div class="bg-bg-secondary p-6 rounded-lg border border-border-primary">
                        <h2 class="text-lg font-semibold mb-4">Timeline Eventi Recenti</h2>
                        <ul class="space-y-4">
                           <li v-for="s in recenti" :key="s.id" class="flex gap-3">
                                <div class="w-8 h-8 rounded-full flex items-center justify-center shrink-0" :class="priorityColor(s.priorita).bg">
                                    <hero-icon name="ExclamationTriangleIcon" class="w-5 h-5 text-white"></hero-icon>
                                </div>
                                <div>
                                    <p class="font-medium text-text-primary">{{ s.codice }} - {{ s.descrizione }}</p>
                                    <p class="text-xs text-text-tertiary">{{ formatRelativeTime(s.dataCreazione) }}</p>
                                </div>
                           </li>
                           <li v-if="recenti.length === 0">
                                <p class="text-text-secondary text-center py-4">Nessun evento recente.</p>
                           </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </script>
    
    <!-- Template Segnalazioni (SegnalazioniView.vue) -->
    <script type="text/x-template" id="segnalazioni-view-template">
        <div>
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-2xl font-bold">Gestione Segnalazioni</h1>
                <button @click="openNewSegnalazioneModal" class="btn btn-primary">
                    <hero-icon name="PlusIcon" class="icon inline-block -ml-1 mr-1"></hero-icon>
                    Aggiungi Segnalazione
                </button>
            </div>
            
            <div class="bg-bg-secondary border border-border-primary rounded-lg overflow-hidden">
                <div class="p-4 border-b border-border-primary">
                    <input type="text" v-model="search" class="form-input" placeholder="Cerca per codice, descrizione, indirizzo...">
                </div>
                <table class="w-full text-left">
                    <thead class="bg-bg-tertiary text-xs text-text-secondary uppercase">
                        <tr>
                            <th class="p-4">Codice</th>
                            <th class="p-4">Priorità</th>
                            <th class="p-4">Stato</th>
                            <th class="p-4">Descrizione</th>
                            <th class="p-4">Località</th>
                            <th class="p-4">Data Creazione</th>
                            <th class="p-4"></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="s in filteredSegnalazioni" :key="s.id" class="border-b border-border-primary hover:bg-bg-tertiary">
                            <td class="p-4 font-mono font-semibold">{{ s.codice }}</td>
                            <td class="p-4">
                                <span class="badge" :class="priorityColor(s.priorita).bg + ' ' + priorityColor(s.priorita).text">{{ s.priorita }}</span>
                            </td>
                            <td class="p-4">
                                <span class="badge" :class="statusColor(s.stato).bg + ' ' + statusColor(s.stato).text">{{ s.stato }}</span>
                            </td>
                            <td class="p-4 max-w-xs truncate" :title="s.descrizione">{{ s.descrizione }}</td>
                            <td class="p-4 max-w-xs truncate" :title="s.localita.indirizzo + ', ' + s.localita.comune">{{ s.localita.indirizzo }}</td>
                            <td class="p-4">{{ formatDateTime(s.dataCreazione) }}</td>
                            <td class="p-4 text-right">
                                <button class="text-text-secondary hover:text-accent-hover">
                                    <hero-icon name="EllipsisVerticalIcon" class="icon"></hero-icon>
                                </button>
                            </td>
                        </tr>
                        <tr v-if="filteredSegnalazioni.length === 0">
                            <td colspan="7" class="text-center py-8 text-text-secondary">Nessuna segnalazione trovata.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </script>
    
    <!-- Template Modal Nuova Segnalazione -->
    <script type="text/x-template" id="segnalazione-form-modal-template">
        <div class="fixed inset-0 bg-black/60 flex items-center justify-center z-50" @click.self="$emit('close')">
            <div class="bg-bg-secondary rounded-lg shadow-xl w-full max-w-2xl border border-border-primary">
                <div class="p-6 border-b border-border-primary flex justify-between items-center">
                    <h2 class="text-xl font-bold">Nuova Segnalazione</h2>
                    <button @click="$emit('close')" class="text-text-secondary hover:text-text-primary">
                        <hero-icon name="XMarkIcon" class="w-6 h-6"></hero-icon>
                    </button>
                </div>
                <form @submit.prevent="handleSubmit">
                    <div class="p-6 space-y-4 max-h-[70vh] overflow-y-auto">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="form-label">Priorità</label>
                                <select v-model="form.priorita" class="form-input" required>
                                    <option>BASSA</option>
                                    <option>MEDIA</option>
                                    <option>ALTA</option>
                                    <option>CRITICA</option>
                                </select>
                            </div>
                            <div>
                                <label class="form-label">Tipologia</label>
                                <input type="text" v-model="form.tipologia" class="form-input" placeholder="Es. Allagamento" required>
                            </div>
                        </div>
                         <div>
                            <label class="form-label">Descrizione Breve</label>
                            <input type="text" v-model="form.descrizione" class="form-input" placeholder="Descrizione sintetica dell'evento" required>
                        </div>
                        <fieldset class="border border-border-primary p-4 rounded-md">
                            <legend class="text-sm font-semibold px-2">Richiedente</legend>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="form-label">Nome e Cognome</label>
                                    <input type="text" v-model="form.richiedente.nome" class="form-input" required>
                                </div>
                                <div>
                                    <label class="form-label">Telefono</label>
                                    <input type="tel" v-model="form.richiedente.telefono" class="form-input" required>
                                </div>
                            </div>
                        </fieldset>
                        <fieldset class="border border-border-primary p-4 rounded-md">
                            <legend class="text-sm font-semibold px-2">Località</legend>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="form-label">Indirizzo</label>
                                    <input type="text" v-model="form.localita.indirizzo" class="form-input" required>
                                </div>
                                <div>
                                    <label class="form-label">Comune</label>
                                    <input type="text" v-model="form.localita.comune" class="form-input" required>
                                </div>
                            </div>
                        </fieldset>
                         <div>
                            <label class="form-label">Note Aggiuntive</label>
                            <textarea v-model="form.note" rows="3" class="form-input" placeholder="Dettagli aggiuntivi, persone coinvolte, ecc."></textarea>
                        </div>
                    </div>
                    <div class="p-6 bg-bg-tertiary rounded-b-lg flex justify-end gap-4">
                        <button type="button" @click="$emit('close')" class="btn btn-secondary">Annulla</button>
                        <button type="submit" class="btn btn-primary">Salva Segnalazione</button>
                    </div>
                </form>
            </div>
        </div>
    </script>
    
    <!-- Template Generico per pagine non implementate -->
    <script type="text/x-template" id="placeholder-view-template">
        <div class="flex flex-col items-center justify-center h-full text-center">
            <component :is="icon" class="w-16 h-16 text-text-tertiary mb-4"></component>
            <h1 class="text-2xl font-bold">Modulo: {{ title }}</h1>
            <p class="text-text-secondary mt-2">Questa sezione è in fase di sviluppo.</p>
        </div>
    </script>


    <!-- ====================================================================== -->
    <!-- LOGICA DELL'APPLICAZIONE (JAVASCRIPT) -->
    <!-- ====================================================================== -->
    <script type="module">
        const { createApp, ref, reactive, computed, onMounted, shallowRef } = Vue;

        // --- 1. DATABASE SETUP (Dexie.js) ---
        const db = new Dexie('ThunderDB');
        db.version(1).stores({
            segnalazioni: '++id, codice, stato, priorita, dataCreazione',
            // ...altre tabelle come da specifica...
        });

        async function initializeSampleData() {
            const count = await db.segnalazioni.count();
            if (count === 0) {
                console.log("Database vuoto, inserimento dati di esempio.");
                await db.segnalazioni.bulkAdd([
                    {
                        codice: 'SEG-2024-0001',
                        tipologia: 'ALLAGAMENTO',
                        priorita: 'CRITICA',
                        stato: 'APERTA',
                        richiedente: { nome: 'Mario Rossi', telefono: '3331234567' },
                        descrizione: 'Cantina allagata in condominio',
                        localita: { indirizzo: 'Via Garibaldi 10', comune: 'Roma', provincia: 'RM' },
                        dataCreazione: Date.now() - 1000 * 60 * 5, // 5 min fa
                        note: 'Acqua alta circa 50cm, possibile rischio elettrico.'
                    },
                    {
                        codice: 'SEG-2024-0002',
                        tipologia: 'FRANA',
                        priorita: 'ALTA',
                        stato: 'APERTA',
                        richiedente: { nome: 'Luigi Verdi', telefono: '3477654321' },
                        descrizione: 'Smottamento su strada provinciale 15',
                        localita: { indirizzo: 'SP15, km 5', comune: 'Genova', provincia: 'GE' },
                        dataCreazione: Date.now() - 1000 * 60 * 60 * 2, // 2 ore fa
                        note: 'La strada è parzialmente bloccata.'
                    },
                     {
                        codice: 'SEG-2024-0003',
                        tipologia: 'INCENDIO BOSCHIVO',
                        priorita: 'MEDIA',
                        stato: 'IN_CORSO',
                        richiedente: { nome: 'Centrale VVF', telefono: '115' },
                        descrizione: 'Fumo visibile da collina Montepellegrino',
                        localita: { indirizzo: 'Zona Belvedere', comune: 'Palermo', provincia: 'PA' },
                        dataCreazione: Date.now() - 1000 * 60 * 60 * 8, // 8 ore fa
                        note: 'Squadre VVF già sul posto, richiesto supporto logistico.'
                    }
                ]);
            }
        }


        // --- 2. STATE MANAGEMENT (Simile a Pinia) ---
        const store = reactive({
            segnalazioni: [],
            loading: false,

            // Getters
            stats: computed(() => ({
                totali: store.segnalazioni.length,
                aperte: store.segnalazioni.filter(s => s.stato === 'APERTA').length,
                inCorso: store.segnalazioni.filter(s => s.stato === 'IN_CORSO').length,
            })),
            segnalazioniCritiche: computed(() => store.segnalazioni.filter(s => s.priorita === 'CRITICA' && s.stato !== 'CHIUSA')),
            segnalazioniRecenti: computed(() => [...store.segnalazioni].sort((a,b) => b.dataCreazione - a.dataCreazione).slice(0, 5)),

            // Actions
            async fetchSegnalazioni() {
                this.loading = true;
                this.segnalazioni = await db.segnalazioni.toArray();
                this.loading = false;
            },
            async generateCodice() {
                const anno = new Date().getFullYear();
                const count = await db.segnalazioni.where('codice').startsWith(`SEG-${anno}`).count();
                return `SEG-${anno}-${String(count + 1).padStart(4, '0')}`;
            },
            async createSegnalazione(data) {
                const codice = await this.generateCodice();
                const nuova = {
                    ...data,
                    codice,
                    dataCreazione: Date.now(),
                    stato: 'APERTA'
                };
                await db.segnalazioni.add(nuova);
                await this.fetchSegnalazioni();
            }
        });


        // --- 3. ROUTER (Semplice, basato su hash) ---
        const routes = {
            '/': 'DashboardView',
            '/segnalazioni': 'SegnalazioniView',
            '/interventi': 'InterventiView',
            '/mappa': 'MappaView',
            '/squadre': 'SquadreView',
            '/diario': 'DiarioView',
        };

        const currentPath = ref(window.location.hash.slice(1) || '/');
        const currentView = computed(() => routes[currentPath.value] || 'DashboardView');

        window.addEventListener('hashchange', () => {
            currentPath.value = window.location.hash.slice(1) || '/';
        });

        function navigateTo(path) {
            window.location.hash = path;
        }


        // --- 4. UTILITY FUNCTIONS ---
        const priorityColor = (p) => {
            switch(p) {
                case 'CRITICA': return { bg: 'bg-status-critical', text: 'text-white' };
                case 'ALTA': return { bg: 'bg-status-high', text: 'text-black' };
                case 'MEDIA': return { bg: 'bg-status-medium', text: 'text-white' };
                case 'BASSA': return { bg: 'bg-status-low', text: 'text-white' };
                default: return { bg: 'bg-gray-500', text: 'text-white' };
            }
        };
        const statusColor = (s) => {
            switch(s) {
                case 'APERTA': return { bg: 'bg-status-high', text: 'text-black' };
                case 'IN_CORSO': return { bg: 'bg-status-medium', text: 'text-white' };
                case 'CHIUSA': return { bg: 'bg-gray-500', text: 'text-white' };
                default: return { bg: 'bg-gray-500', text: 'text-white' };
            }
        };
        const formatDateTime = (ts) => dayjs(ts).format('DD/MM/YYYY HH:mm');
        const formatRelativeTime = (ts) => {
            const now = dayjs();
            const then = dayjs(ts);
            if (now.diff(then, 'minute') < 60) return `${now.diff(then, 'minute')} min fa`;
            if (now.diff(then, 'hour') < 24) return `${now.diff(then, 'hour')} ore fa`;
            return then.format('DD/MM/YYYY');
        };

        // --- 5. COMPONENTI VUE ---

        // Icona Wrapper
        const HeroIcon = {
            props: ['name'],
            template: `<i :data-heroicons-name="name" class="inline-block"></i>`
        };

        const PlaceholderView = {
            template: '#placeholder-view-template',
            components: { HeroIcon },
            props: { title: String, icon: String }
        };

        const SegnalazioneFormModal = {
            template: '#segnalazione-form-modal-template',
            components: { HeroIcon },
            emits: ['close'],
            setup(props, { emit }) {
                const form = ref({
                    priorita: 'MEDIA',
                    tipologia: '',
                    descrizione: '',
                    richiedente: { nome: '', telefono: '' },
                    localita: { indirizzo: '', comune: '' },
                    note: ''
                });

                async function handleSubmit() {
                    await store.createSegnalazione(form.value);
                    emit('close');
                }

                return { form, handleSubmit };
            }
        };

        const DashboardView = {
            template: '#dashboard-view-template',
            components: { HeroIcon },
            setup() {
                return {
                    stats: store.stats,
                    critiche: store.segnalazioniCritiche,
                    recenti: store.segnalazioniRecenti,
                    formatRelativeTime,
                    priorityColor
                }
            }
        };

        const SegnalazioniView = {
            template: '#segnalazioni-view-template',
            components: { HeroIcon },
            setup() {
                const search = ref('');
                const filteredSegnalazioni = computed(() => {
                    const term = search.value.toLowerCase();
                    if (!term) return store.segnalazioni;
                    return store.segnalazioni.filter(s =>
                        s.codice.toLowerCase().includes(term) ||
                        s.descrizione.toLowerCase().includes(term) ||
                        s.localita.indirizzo.toLowerCase().includes(term)
                    );
                });

                return { 
                    search, 
                    filteredSegnalazioni, 
                    priorityColor,
                    statusColor,
                    formatDateTime,
                    openNewSegnalazioneModal: () => app.isNewSegnalazioneModalOpen = true
                }
            }
        };

        // --- 6. APPLICAZIONE PRINCIPALE ---
        const app = createApp({
            template: '#app-template',
            components: {
                DashboardView,
                SegnalazioniView,
                SegnalazioneFormModal,
                InterventiView: { extends: PlaceholderView, props: { title: { default: 'Interventi'}, icon: { default: 'WrenchScrewdriverIcon' } } },
                MappaView: { extends: PlaceholderView, props: { title: { default: 'Mappa'}, icon: { default: 'MapIcon' } } },
                SquadreView: { extends: PlaceholderView, props: { title: { default: 'Squadre'}, icon: { default: 'UserGroupIcon' } } },
                DiarioView: { extends: PlaceholderView, props: { title: { default: 'Diario Sala'}, icon: { default: 'BookOpenIcon' } } },
                HeroIcon
            },
            setup() {
                const currentTime = ref(dayjs().format('HH:mm:ss'));
                const currentDate = ref(dayjs().format('dddd D MMMM YYYY'));
                const isNewSegnalazioneModalOpen = ref(false);

                onMounted(async () => {
                    // Carica dati iniziali
                    await initializeSampleData();
                    await store.fetchSegnalazioni();

                    // Aggiorna orologio
                    setInterval(() => {
                        currentTime.value = dayjs().format('HH:mm:ss');
                        if (dayjs().second() === 0) {
                           currentDate.value = dayjs().format('dddd D MMMM YYYY');
                        }
                    }, 1000);
                    
                    // Rende le icone
                    heroicons.render();
                });

                const navItems = computed(() => [
                    { name: 'Dashboard', path: '/', icon: 'HomeIcon' },
                    { name: 'Segnalazioni', path: '/segnalazioni', icon: 'MegaphoneIcon', badge: { value: store.stats.aperte, class: 'bg-status-critical text-white' } },
                    { name: 'Interventi', path: '/interventi', icon: 'WrenchScrewdriverIcon' },
                    { name: 'Squadre', path: '/squadre', icon: 'UserGroupIcon' },
                    { name: 'Mappa', path: '/mappa', icon: 'MapIcon' },
                    { name: 'Diario Sala', path: '/diario', icon: 'BookOpenIcon' },
                ]);

                return {
                    currentTime,
                    currentDate,
                    currentPath,
                    currentView,
                    navigateTo,
                    stats: store.stats,
                    navItems,
                    isNewSegnalazioneModalOpen,
                    openNewSegnalazioneModal: () => isNewSegnalazioneModalOpen.value = true,
                    closeNewSegnalazioneModal: () => isNewSegnalazioneModalOpen.value = false,
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
